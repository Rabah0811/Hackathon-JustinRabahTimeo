<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Admin Sui ‚Äî Registry & Diplomas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0f172a; color:#e2e8f0; padding:24px; }
    h1, h2 { color:#fff; }
    .row { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:16px; }
    label { display:block; font-size:12px; color:#94a3b8; margin-bottom:6px; }
    input, textarea { width:100%; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; padding:10px 12px; font-family:monospace; }
    textarea { min-height:70px; }
    .btn { display:inline-block; border:1px solid #334155; background:#1d4ed8; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#0b1220; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .row .btn { width:100%; text-align:center; }
    .muted { color:#94a3b8; font-size:12px; }
    .ok { color:#10b981; }
    .err { color:#ef4444; white-space:pre-wrap; }
    .out { background:#0b1220; border:1px dashed #334155; border-radius:10px; padding:10px; font-family:monospace; white-space:pre-wrap; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  </style>
</head>
<body>
  <h1>üõ†Ô∏è Admin Sui ‚Äî Registry & Diplomas</h1>
  <p class="muted">Connecte ton wallet Sui (extension) sur <strong>Localnet</strong>, puis utilise les formulaires.</p>

  <div class="row" style="margin-bottom:16px">
    <div class="card">
      <button id="btnConnect" class="btn">üîå Connecter le wallet</button>
      <div id="whoami" class="muted" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <label>Fullnode</label>
      <div id="rpcInfo" class="muted">localnet</div>
      <div id="rpcPing" class="muted"></div>
    </div>
  </div>

  <div class="row" style="margin-bottom:16px">
    <div class="card">
      <h2>üì¶ Param√®tres</h2>
      <label for="pkg">PackageID</label>
      <input id="pkg" placeholder="0x... (ton dernier publish)" />

      <label for="reg" style="margin-top:10px">Registry ObjectID</label>
      <input id="reg" placeholder="0x... (Issuers)" />

      <label for="issuer" style="margin-top:10px">Issuer (address)</label>
      <input id="issuer" placeholder="0x... (souvent ton wallet)" />

      <label for="recipient" style="margin-top:10px">Recipient (address)</label>
      <input id="recipient" placeholder="0x... (peut √™tre toi pour tester)" />
    </div>

    <div class="card">
      <h2>üìù Metadata (Diploma)</h2>
      <div class="grid2">
        <div>
          <label for="degree">degree_name (UTF-8)</label>
          <input id="degree" placeholder="Bachelor CS" />
        </div>
        <div>
          <label for="institution">institution_name (UTF-8)</label>
          <input id="institution" placeholder="University" />
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <label for="year">graduation_year (u64)</label>
          <input id="year" type="number" placeholder="2025" />
        </div>
        <div>
          <label for="pdfurl">pdf_url (ex: ipfs://...)</label>
          <input id="pdfurl" placeholder="ipfs://Qm..." />
        </div>
      </div>
      <label for="hash" style="margin-top:10px">degree_hash (UTF-8 ou hex)</label>
      <input id="hash" placeholder="ex: SHA-256 du PDF (0x... ou texte 'hash')" />
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>üèÅ Registry</h2>
      <button id="btnInit" class="btn secondary">Init Registry (init_registry)</button>
      <div style="height:8px"></div>
      <button id="btnAddIssuer" class="btn secondary">Add Issuer (add_issuer)</button>
    </div>
    <div class="card">
      <h2>üéì Diploma</h2>
      <button id="btnMint" class="btn">Mint Diploma (mint_diploma_entry)</button>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>üñ®Ô∏è Sorties</h2>
    <div id="out" class="out"></div>
    <div id="err" class="err" style="margin-top:10px"></div>
  </div>
    <script type="importmap">
    {
    "imports": {
        "@mysten/bcs": "https://cdn.jsdelivr.net/npm/@mysten/bcs@0.11.0/dist/index.js"
    }
    }
    </script>
  <script type="module">
    import { SuiClient, getFullnodeUrl } from "https://cdn.jsdelivr.net/npm/@mysten/sui@1.17.0/dist/esm/client/index.js";
    import { TransactionBlock } from "https://cdn.jsdelivr.net/npm/@mysten/sui@1.17.0/dist/esm/transactions/index.js";

    // --- Config client vers localnet
    const client = new SuiClient({ url: getFullnodeUrl("localnet") });

    // --- Helpers
    const $ = (id) => document.getElementById(id);
    const out = (x) => { $('out').textContent = (typeof x === 'string') ? x : JSON.stringify(x, null, 2); $('err').textContent = ''; };
    const oops = (e) => { $('err').textContent = (e?.message || String(e)); };

    function utf8ToHex(str) {
      if (!str) return "0x";
      const enc = new TextEncoder().encode(str);
      return "0x" + Array.from(enc).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function normalizeVecU8Input(v) {
      // Tu peux fournir "0x..." (on le garde) ou un texte ‚Üí on convertit en 0x...
      if (!v) return "0x";
      if (typeof v === 'string' && v.startsWith('0x')) return v;
      return utf8ToHex(String(v));
    }

    // --- Wallet (Sui Wallet extension)
    let accounts = [];
    let active = null;

    async function connectWallet() {
      if (!window.sui?.request) throw new Error("Sui Wallet non d√©tect√©. Installe l'extension et rafra√Æchis.");
      // standard API
      const perms = await window.sui.request({ method: "wallet_requestPermissions", params: [{ permissions: ["viewAccount", "suggestTransactions"] }] });
      accounts = (await window.sui.request({ method: "sui_getAccounts" })) || [];
      active = accounts[0]?.address || null;
      $('whoami').innerHTML = active ? ("Connect√© : <span class='ok'>" + active + "</span>") : "Aucun compte";
      return active;
    }

    async function signAndExecute(txb) {
      if (!active) await connectWallet();
      const txbBytes = await txb.build({ client });
      const res = await window.sui.request({
        method: "sui_signAndExecuteTransactionBlock",
        params: {
          transactionBlock: txbBytes,
          options: { showEffects: true, showObjectChanges: true, showEvents: true }
        }
      });
      return res;
    }

    // --- Ping localnet
    (async () => {
      try {
        const res = await client.getChainIdentifier();
        $('rpcPing').innerHTML = "RPC OK : <span class='ok'>" + res + "</span>";
      } catch (e) {
        $('rpcPing').innerHTML = "<span class='err'>RPC KO : " + (e?.message || e) + "</span>";
      }
    })();

    // --- UI handlers
    $('btnConnect').onclick = async () => { try { await connectWallet(); out({ accounts }); } catch (e) { oops(e); } };

    $('btnInit').onclick = async () => {
      try {
        const pkg = $('pkg').value.trim();
        const issuer = $('issuer').value.trim();
        if (!pkg || !issuer) throw new Error("Renseigne PackageID et Issuer.");
        const txb = new TransactionBlock();
        txb.moveCall({
          target: `${pkg}::registry::init_registry`,
          arguments: [ txb.pure.address(issuer) ],
        });
        const r = await signAndExecute(txb);
        out(r);
      } catch (e) { oops(e); }
    };

    $('btnAddIssuer').onclick = async () => {
      try {
        const pkg = $('pkg').value.trim();
        const reg = $('reg').value.trim();
        const issuer = $('issuer').value.trim();
        const sender = active;
        if (!pkg || !reg || !issuer || !sender) throw new Error("Renseigne PackageID, RegistryID, Issuer, et connecte ton wallet.");
        const txb = new TransactionBlock();
        txb.moveCall({
          target: `${pkg}::registry::add_issuer`,
          arguments: [
            txb.object(reg),
            txb.pure.address(issuer),
            txb.pure.address(sender),
          ],
        });
        const r = await signAndExecute(txb);
        out(r);
      } catch (e) { oops(e); }
    };

    $('btnMint').onclick = async () => {
      try {
        const pkg = $('pkg').value.trim();
        const reg = $('reg').value.trim();
        const issuerAddr = $('issuer').value.trim();
        const recipientAddr = $('recipient').value.trim();
        if (!pkg || !reg || !issuerAddr || !recipientAddr) throw new Error("Renseigne PackageID, RegistryID, Issuer, Recipient.");

        // Champs metadata
        const degree = normalizeVecU8Input($('degree').value.trim());
        const institution = normalizeVecU8Input($('institution').value.trim());
        const year = Number($('year').value.trim() || "0");
        const pdfurl = normalizeVecU8Input($('pdfurl').value.trim());

        const degreeHash = normalizeVecU8Input($('hash').value.trim());

        // tx
        const txb = new TransactionBlock();
        txb.moveCall({
          target: `${pkg}::diploma::mint_diploma_entry`,
          arguments: [
            txb.object(reg),
            txb.pure.address(issuerAddr),
            txb.pure.address(recipientAddr),
            txb.pure(degreeHash),       // vector<u8>
            txb.pure(degree),           // degree_name: vector<u8>
            txb.pure(institution),      // institution_name: vector<u8>
            txb.pure(u64(year)),        // graduation_year: u64
            txb.pure(pdfurl),           // pdf_url: vector<u8>
          ],
        });

        const r = await signAndExecute(txb);
        out(r);
      } catch (e) { oops(e); }
    };

    // petit helper u64 (Sui SDK accepte number pour u64, mais on le marque explicitement)
    function u64(n){ return Number(n); }
  </script>
</body>
</html>